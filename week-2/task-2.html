<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>簡易防禦塔格狀小遊戲</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 5px;
    }
    button {
      margin-right: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #board {
      margin-top: 10px;
      border-collapse: collapse;
    }
    #board td {
      width: 32px;
      height: 32px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #999;
      font-weight: bold;
    }
    #log {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      background-color: #f9f9f9;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>簡易防禦塔格狀小遊戲</h1>
  <p>按下「Start Game」後，系統會自動進行 10 回合並更新下方格子與日誌。</p>
  <button onclick="startGame()">Start Game</button>

  <!-- 遊戲地圖 -->
  <table id="board"></table>

  <!-- 日誌顯示區域 -->
  <div id="log"></div>

  <script>
    /*************************************************
     * 1. 基本設定
     *************************************************/
    const minX = -15, maxX = 25;
    const minY = -10,  maxY = 15;
    const totalCols = maxX - minX + 1; // 21
    const totalRows = maxY - minY + 1; // 11
    let currentTurn = 0;
    let maxTurns = 10;
    let gameInterval = null;

    // 將 (x, y) 座標轉換成表格中的 (row, col)
    // row 從上到下，col 從左到右
    // 例如 y = 5 => rowIndex = 0,   x = -10 => colIndex = 0
    //      y = -5 => rowIndex = 10, x = 10  => colIndex = 20
    function getRowCol(x, y) {
      const row = maxY - y;   // maxY 在最上面
      const col = x - minX;   // minX 在最左邊
      return { row, col };
    }

    // 顯示訊息到日誌區
    function logMessage(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerText += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    /*************************************************
     * 2. 建立 Position, Enemy, Tower 類別
     *************************************************/
    class Position {
      constructor(x, y) {
        this.x = x;
        this.y = y;
      }
      distanceTo(other) {
        return Math.sqrt((this.x - other.x) ** 2 + (this.y - other.y) ** 2);
      }
      move(vector) {
        this.x += vector[0];
        this.y += vector[1];
      }
      toString() {
        return `(${this.x}, ${this.y})`;
      }
    }

    class Enemy {
      constructor(label, position, moveVector) {
        this.label = label;
        this.position = new Position(position[0], position[1]);
        this.moveVector = moveVector;
        this.lifePoints = 10;
        this.isDead = false;
      }
      move() {
        if (!this.isDead) {
          this.position.move(this.moveVector);
        }
      }
      takeDamage(damage) {
        if (!this.isDead) {
          this.lifePoints -= damage;
          if (this.lifePoints <= 0) {
            this.lifePoints = 0;
            this.isDead = true;
          }
        }
      }
      toString() {
        return `${this.label} at ${this.position.toString()}, HP: ${this.lifePoints}`;
      }
    }

    class Tower {
      constructor(label, position, attackPoints, attackRange) {
        this.label = label;
        this.position = new Position(position[0], position[1]);
        this.attackPoints = attackPoints;
        this.attackRange = attackRange;
      }
      canAttack(enemy) {
        if (enemy.isDead) {
          return false;
        }
        return this.position.distanceTo(enemy.position) <= this.attackRange;
      }
      attack(enemies) {
        enemies.forEach(enemy => {
          if (this.canAttack(enemy)) {
            enemy.takeDamage(this.attackPoints);
          }
        });
      }
    }

    /*************************************************
     * 3. 建立遊戲主流程 (Game) 
     *************************************************/
    class Game {
      constructor() {
        // 初始化敵人
        this.enemies = [
          new Enemy("E1", [-10, 2], [2, -1]),
          new Enemy("E2", [-8, 0],  [3, 1]),
          new Enemy("E3", [-9, -1], [3, 0])
        ];
        
        // 初始化基礎防禦塔
        this.basicTowers = [
          new Tower("T1", [-3, 2], 1, 2),
          new Tower("T2", [-1, -2], 1, 2),
          new Tower("T3", [4, 2], 1, 2),
          new Tower("T4", [7, 0], 1, 2)
        ];
        
        // 初始化進階防禦塔
        this.advancedTowers = [
          new Tower("A1", [1, 1], 2, 4),
          new Tower("A2", [4, -3], 2, 4)
        ];
      }

      // 執行一個回合
      runTurn(turnNumber) {
        logMessage(`\n=== Turn ${turnNumber} ===`);

        // 1. 移動所有敵人
        this.enemies.forEach(enemy => {
          enemy.move();
        });

        // 2. 所有防禦塔進行攻擊
        [...this.basicTowers, ...this.advancedTowers].forEach(tower => {
          tower.attack(this.enemies);
        });

        // 顯示當前狀態
        this.enemies.forEach(enemy => {
          logMessage(enemy.toString());
        });
      }
    }

    // 建立全域 game 物件
    let game = null;

    /*************************************************
     * 4. 產生格子地圖，並在每個回合更新
     *************************************************/
    function createBoard() {
      const board = document.getElementById('board');
      board.innerHTML = ''; // 先清空

      // 建立 rows x cols 的表格
      for (let r = 0; r < totalRows; r++) {
        const tr = document.createElement('tr');
        for (let c = 0; c < totalCols; c++) {
          const td = document.createElement('td');
          td.innerText = '.';  // 預設顯示一個「.」
          tr.appendChild(td);
        }
        board.appendChild(tr);
      }
    }

    // 將敵人、塔等標記到格子上
    function updateBoard() {
      // 先把整個表格都重置成 "."
      const board = document.getElementById('board');
      for (let r = 0; r < totalRows; r++) {
        const row = board.rows[r];
        for (let c = 0; c < totalCols; c++) {
          row.cells[c].innerText = '.';
        }
      }

      // 標記防禦塔 (T or A)
      [...game.basicTowers, ...game.advancedTowers].forEach(tower => {
        const { row, col } = getRowCol(tower.position.x, tower.position.y);
        if (row >= 0 && row < totalRows && col >= 0 && col < totalCols) {
          // 進階塔 A，普通塔 T
          const isAdvanced = game.advancedTowers.includes(tower);
          board.rows[row].cells[col].innerText = isAdvanced ? tower.label : tower.label;
        }
      });

      // 標記敵人 (E)
      game.enemies.forEach(enemy => {
        const { row, col } = getRowCol(enemy.position.x, enemy.position.y);
        if (row >= 0 && row < totalRows && col >= 0 && col < totalCols) {
          // 如果活著就顯示 enemy.label，例如 E1
          // 如果死了就顯示另外的符號
          board.rows[row].cells[col].innerText = enemy.isDead ? 'X' : enemy.label;
        }
      });
      
    }

    /*************************************************
     * 5. 按鈕事件：開始遊戲 / 單回合執行
     *************************************************/
    function startGame() {
      // 清空日誌
      document.getElementById('log').innerText = "";

      // 初始化遊戲物件
      game = new Game();
      currentTurn = 0;

      // 產生初始地圖
      createBoard();
      updateBoard();
      logMessage("Game Start!");

      // 若已經有 setInterval，先清掉
      if (gameInterval) {
        clearInterval(gameInterval);
      }

      // 每 1 秒自動執行一次回合，總計 10 回合
      gameInterval = setInterval(() => {
        currentTurn++;
        game.runTurn(currentTurn);
        updateBoard();
        if (currentTurn >= maxTurns) {
          clearInterval(gameInterval);
          logMessage("\nGame Over!");
          logMessage("\nFinal Status:");
          game.enemies.forEach(enemy => {
            logMessage(
              `${enemy.label} - Final Position: ${enemy.position.toString()}, Life Points: ${enemy.lifePoints}`
            );
          });
        }
      }, 1000);
    }

    // 進入網頁時，先建立一次空白地圖
    window.onload = () => {
      createBoard();
    };
  </script>
</body>
</html>
